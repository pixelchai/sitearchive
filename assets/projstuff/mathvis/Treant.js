(function(){var n={inheritAttrs:function(n,t){for(var i in t)typeof t[i]!="function"&&(n[i]instanceof Object&&t[i]instanceof Object?this.inheritAttrs(n[i],t[i]):n[i]=t[i])},createMerge:function(n,t){var i={};return n&&this.inheritAttrs(i,this.cloneObj(n)),t&&this.inheritAttrs(i,t),i},cloneObj:function(n){var i,t;if(Object(n)!==n)return n;i=new n.constructor;for(t in n)n.hasOwnProperty(t)&&(i[t]=this.cloneObj(n[t]));return i},addEvent:function(n,t,i){n.addEventListener?n.addEventListener(t,i,!1):n.attachEvent?n.attachEvent("on"+t,i):n["on"+t]=i},hasClass:function(n,t){return(" "+n.className+" ").replace(/[\n\t]/g," ").indexOf(" "+t+" ")>-1}},e=function(){this.loading=[]},r,i,u,t,o,f;e.prototype={processNode:function(n){for(var t=n.nodeDOM.getElementsByTagName("img"),i=t.length;i--;)this.create(n,t[i])},removeAll:function(n){for(var t=this.loading.length;t--;)this.loading[t]===n&&this.loading.splice(t,1)},create:function(t,i){function r(){f.removeAll(u);t.width=t.nodeDOM.offsetWidth;t.height=t.nodeDOM.offsetHeight}var f=this,u=i.src;if(this.loading.push(u),i.complete)return r();n.addEvent(i,"load",r);n.addEvent(i,"error",r);i.src+="?"+(new Date).getTime()},isNotLoading:function(){return this.loading.length===0}};r={store:[],createTree:function(n){return this.store.push(new i(n,this.store.length)),this.store[this.store.length-1]},get:function(n){return this.store[n]},destroy:function(n){var u=this.get(n),t,f,e,i,r;if(u){for(u._R.remove(),t=u.drawArea;t.firstChild;)t.removeChild(t.firstChild);for(f=t.className.split(" "),e=[],i=0;i<f.length;i++)r=f[i],r!="Treant"&&r!="Treant-loaded"&&e.push(r);t.style.overflowY="";t.style.overflowX="";t.className=e.join(" ");this.store[n]=null}}};i=function(t,r){this.id=r;this.imageLoader=new e;this.CONFIG=n.createMerge(i.CONFIG,t.chart);this.drawArea=document.getElementById(this.CONFIG.container.substring(1));this.drawArea.className+=" Treant";this.nodeDB=new u(t.nodeStructure,this);this.connectionStore={}};i.prototype={positionTree:function(n){var i=this,t,r;this.imageLoader.isNotLoading()?(t=this.root(),r=this.CONFIG.rootOrientation,this.resetLevelData(),this.firstWalk(t,0),this.secondWalk(t,0,0,0),this.positionNodes(),this.CONFIG.animateOnInit&&setTimeout(function(){t.toggleCollapse()},this.CONFIG.animateOnInitDelay),this.loaded||(this.drawArea.className+=" Treant-loaded",Object.prototype.toString.call(n)==="[object Function]"&&n(i),this.loaded=!0)):setTimeout(function(){i.positionTree(n)},10)},firstWalk:function(n,t){var i,r,f,u;if(n.prelim=null,n.modifier=null,this.setNeighbors(n,t),this.calcLevelDim(n,t),i=n.leftSibling(),n.childrenCount()===0||t==this.CONFIG.maxDepth)n.prelim=i?i.prelim+i.size()+this.CONFIG.siblingSeparation:0;else{for(r=0,f=n.childrenCount();r<f;r++)this.firstWalk(n.childAt(r),t+1);u=n.childrenCenter()-n.size()/2;i?(n.prelim=i.prelim+i.size()+this.CONFIG.siblingSeparation,n.modifier=n.prelim-u,this.apportion(n,t)):n.prelim=u;n.stackParent?n.modifier+=this.nodeDB.get(n.stackChildren[0]).size()/2+n.connStyle.stackIndent:n.stackParentId&&(n.prelim=0)}},apportion:function(n,t){for(var i=n.firstChild(),e=i.leftNeighbor(),h=1,p=this.CONFIG.maxDepth-t,l,r,u,a,f,y;i&&e&&h<=p;){var c=0,v=0,o=e,s=i;for(l=0;l<h;l++)o=o.parent(),s=s.parent(),v+=o.modifier,c+=s.modifier,s.stackParent!==undefined&&(c+=s.size()/2);if(r=e.prelim+v+e.size()+this.CONFIG.subTeeSeparation-(i.prelim+c),r>0){for(u=n,a=0;u&&u.id!=o.id;)u=u.leftSibling(),a++;if(u)for(f=n,y=r/a;f.id!=o.id;)f.prelim+=r,f.modifier+=r,r-=y,f=f.leftSibling()}h++;i=i.childrenCount()===0?n.leftMost(0,h):i.firstChild();i&&(e=i.leftNeighbor())}},secondWalk:function(n,t,i,r){var h;if(t<=this.CONFIG.maxDepth){var c=n.prelim+i,o=r,s=this.CONFIG.nodeAlign,u=this.CONFIG.rootOrientation,f,e;u=="NORTH"||u=="SOUTH"?(f=this.levelMaxDim[t].height,e=n.height,n.pseudo&&(n.height=f)):(u=="WEST"||u=="EAST")&&(f=this.levelMaxDim[t].width,e=n.width,n.pseudo&&(n.width=f));n.X=c;n.pseudo?u=="NORTH"||u=="WEST"?n.Y=o:(u=="SOUTH"||u=="EAST")&&(n.Y=o+(f-e)):n.Y=s=="CENTER"?o+(f-e)/2:s=="TOP"?o+(f-e):o;(u=="WEST"||u=="EAST")&&(h=n.X,n.X=n.Y,n.Y=h);u=="SOUTH"?n.Y=-n.Y-e:u=="EAST"&&(n.X=-n.X-e);n.childrenCount()!==0&&(n.id===0&&this.CONFIG.hideRootNode?this.secondWalk(n.firstChild(),t+1,i+n.modifier,r):this.secondWalk(n.firstChild(),t+1,i+n.modifier,r+f+this.CONFIG.levelSeparation));n.rightSibling()&&this.secondWalk(n.rightSibling(),t,i,r)}},positionNodes:function(){var i=this,t={x:i.nodeDB.getMinMaxCoord("X",null,null),y:i.nodeDB.getMinMaxCoord("Y",null,null)},f=t.x.max-t.x.min,e=t.y.max-t.y.min,s={x:t.x.max-f/2,y:t.y.max-e/2},h={x:i.drawArea.clientWidth/2,y:i.drawArea.clientHeight/2},c=h.x-s.x,l=h.y-s.y,v=t.x.min+c<=0?Math.abs(t.x.min):0,y=t.y.min+l<=0?Math.abs(t.y.min):0,r,a,n,o,u;for(this.handleOverflow(f,e),r=0,a=this.nodeDB.db.length;r<a;r++)(n=this.nodeDB.get(r),n.id===0&&this.CONFIG.hideRootNode)||(n.X+=v+(f<this.drawArea.clientWidth?c:this.CONFIG.padding),n.Y+=y+(e<this.drawArea.clientHeight?l:this.CONFIG.padding),o=n.collapsedParent(),u=null,o?(u=o.connectorPoint(!0),n.hide(u)):n.positioned?n.show():(n.nodeDOM.style.left=n.X+"px",n.nodeDOM.style.top=n.Y+"px",n.positioned=!0),n.id===0||n.parent().id===0&&this.CONFIG.hideRootNode?!this.CONFIG.hideRootNode&&n.drawLineThrough&&n.drawLineThroughMe():this.setConnectionToParent(n,u))},handleOverflow:function(n,t){var r=n<this.drawArea.clientWidth?this.drawArea.clientWidth:n+this.CONFIG.padding*2,u=t<this.drawArea.clientHeight?this.drawArea.clientHeight:t+this.CONFIG.padding*2,i,f,e;this._R?this._R.setSize(r,u):this._R=Raphael(this.drawArea,r,u);this.CONFIG.scrollbar=="native"?(this.drawArea.clientWidth<n&&(this.drawArea.style.overflowX="auto"),this.drawArea.clientHeight<t&&(this.drawArea.style.overflowY="auto")):this.CONFIG.scrollbar=="fancy"&&(i=$(this.drawArea),i.hasClass("ps-container")?(i.find(".Treant").css({width:r,height:u}),i.perfectScrollbar("update")):(f=i.wrapInner('<div class="Treant"/>'),e=f.find(".Treant"),e.css({width:r,height:u}),f.perfectScrollbar()))},setConnectionToParent:function(n,t){var u=n.stackParentId,i,r=u?this.nodeDB.get(u):n.parent(),f=t?this.getPointPathString(t):this.getPathString(r,n,u);this.connectionStore[n.id]?(i=this.connectionStore[n.id],this.animatePath(i,f)):(i=this._R.path(f),this.connectionStore[n.id]=i,n.pseudo&&delete r.connStyle.style["arrow-end"],r.pseudo&&delete r.connStyle.style["arrow-start"],i.attr(r.connStyle.style),(n.drawLineThrough||n.pseudo)&&n.drawLineThroughMe(t))},getPointPathString:function(n){return["_M",n.x,",",n.y,"L",n.x,",",n.y,n.x,",",n.y].join(" ")},animatePath:function(n,t){n.hidden&&t.charAt(0)!=="_"&&(n.show(),n.hidden=!1);n.animate({path:t.charAt(0)==="_"?t.substring(1):t},this.CONFIG.animation.connectorsSpeed,this.CONFIG.animation.connectorsAnimation,function(){t.charAt(0)==="_"&&(n.hide(),n.hidden=!0)})},getPathString:function(n,t,i){var u=n.connectorPoint(!0),r=t.connectorPoint(!1),f=this.CONFIG.rootOrientation,e=n.connStyle.type,o={},s={},v,l;f=="NORTH"||f=="SOUTH"?(o.y=s.y=(u.y+r.y)/2,o.x=u.x,s.x=r.x):(f=="EAST"||f=="WEST")&&(o.x=s.x=(u.x+r.x)/2,o.y=u.y,s.y=r.y);var h=u.x+","+u.y,y=o.x+","+o.y,w=s.x+","+s.y,a=r.x+","+r.y,b=(o.x+s.x)/2+","+(o.y+s.y)/2,c,p;return i?(p=f=="EAST"||f=="WEST"?r.x+","+u.y:u.x+","+r.y,e=="step"||e=="straight"?c=["M",h,"L",p,"L",a]:(e=="curve"||e=="bCurve")&&(l=n.connStyle.stackIndent,f=="NORTH"?v=r.x-l+","+(r.y-l):f=="SOUTH"?v=r.x-l+","+(r.y+l):f=="EAST"?v=r.x+l+","+u.y:f=="WEST"&&(v=r.x-l+","+u.y),c=["M",h,"L",v,"S",p,a])):e=="step"?c=["M",h,"L",y,"L",w,"L",a]:e=="curve"?c=["M",h,"C",y,w,a]:e=="bCurve"?c=["M",h,"Q",y,b,"T",a]:e=="straight"&&(c=["M",h,"L",h,a]),c.join(" ")},setNeighbors:function(n,t){n.leftNeighborId=this.lastNodeOnLevel[t];n.leftNeighborId&&(n.leftNeighbor().rightNeighborId=n.id);this.lastNodeOnLevel[t]=n.id},calcLevelDim:function(n,t){this.levelMaxDim[t]?(this.levelMaxDim[t].width<n.width&&(this.levelMaxDim[t].width=n.width),this.levelMaxDim[t].height<n.height&&(this.levelMaxDim[t].height=n.height)):this.levelMaxDim[t]={width:n.width,height:n.height}},resetLevelData:function(){this.lastNodeOnLevel=[];this.levelMaxDim=[]},root:function(){return this.nodeDB.get(0)}};u=function(t,i){function u(t,f){var e=r.createNode(t,f,i,null),c,s,o,h;if(t.children){if(e.children=[],t.childrenDropLevel&&t.childrenDropLevel>0)while(t.childrenDropLevel--)c=n.cloneObj(e.connStyle),e=r.createNode("pseudo",e.id,i,null),e.connStyle=c,e.children=[];for(s=t.stackChildren&&!r.hasGrandChildren(t)?e.id:null,s!==null&&(e.stackChildren=[]),o=0,h=t.children.length;o<h;o++)s!==null?(e=r.createNode(t.children[o],e.id,i,s),o+1<h&&(e.children=[])):u(t.children[o],e.id)}}this.db=[];var r=this;i.CONFIG.animateOnInit&&(t.collapsed=!0);u(t,-1);this.createGeometries(i)};u.prototype={createGeometries:function(n){for(var t=this.db.length;t--;)this.get(t).createGeometry(n)},get:function(n){return this.db[n]},createNode:function(n,i,r,u){var f=new t(n,this.db.length,i,r,u);return this.db.push(f),i>=0&&this.get(i).children.push(f.id),u&&(this.get(u).stackParent=!0,this.get(u).stackChildren.push(f.id)),f},getMinMaxCoord:function(n,t,i){for(var t=t||this.get(0),u=t.childrenCount(),i=i||{min:t[n],max:t[n]+(n=="X"?t.width:t.height)};u--;){var r=t.childAt(u),f=r[n]+(n=="X"?r.width:r.height),e=r[n];f>i.max&&(i.max=f);e<i.min&&(i.min=e);this.getMinMaxCoord(n,r,i)}return i},hasGrandChildren:function(n){for(var t=n.children.length;t--;)if(n.children[t].children)return!0}};t=function(t,i,r,u,f){this.id=i;this.parentId=r;this.treeId=u.id;this.prelim=0;this.modifier=0;this.stackParentId=f;this.pseudo=t==="pseudo"||t.pseudo;this.image=t.image;this.link=n.createMerge(u.CONFIG.node.link,t.link);this.connStyle=n.createMerge(u.CONFIG.connectors,t.connectors);this.drawLineThrough=t.drawLineThrough===!1?!1:t.drawLineThrough||u.CONFIG.node.drawLineThrough;this.collapsable=t.collapsable===!1?!1:t.collapsable||u.CONFIG.node.collapsable;this.collapsed=t.collapsed;this.text=t.text;this.nodeInnerHTML=t.innerHTML;this.nodeHTMLclass=(u.CONFIG.node.HTMLclass?u.CONFIG.node.HTMLclass:"")+(t.HTMLclass?" "+t.HTMLclass:"");this.nodeHTMLid=t.HTMLid};t.prototype={Tree:function(){return r.get(this.treeId)},dbGet:function(n){return this.Tree().nodeDB.get(n)},size:function(){var n=this.Tree().CONFIG.rootOrientation;return this.pseudo?-this.Tree().CONFIG.subTeeSeparation:n=="NORTH"||n=="SOUTH"?this.width:n=="WEST"||n=="EAST"?this.height:void 0},childrenCount:function(){return this.collapsed||!this.children?0:this.children.length},childAt:function(n){return this.dbGet(this.children[n])},firstChild:function(){return this.childAt(0)},lastChild:function(){return this.childAt(this.children.length-1)},parent:function(){return this.dbGet(this.parentId)},leftNeighbor:function(){if(this.leftNeighborId)return this.dbGet(this.leftNeighborId)},rightNeighbor:function(){if(this.rightNeighborId)return this.dbGet(this.rightNeighborId)},leftSibling:function(){var n=this.leftNeighbor();if(n&&n.parentId==this.parentId)return n},rightSibling:function(){var n=this.rightNeighbor();if(n&&n.parentId==this.parentId)return n},childrenCenter:function(){var n=this.firstChild(),t=this.lastChild();return n.prelim+(t.prelim-n.prelim+t.size())/2},collapsedParent:function(){var n=this.parent();return n?n.collapsed?n:n.collapsedParent():!1},leftMost:function(n,t){var i,u,r;if(n>=t)return this;if(this.childrenCount()!==0)for(i=0,u=this.childrenCount();i<u;i++)if(r=this.childAt(i).leftMost(n+1,t),r)return r},connectorPoint:function(n){var t=this.Tree().CONFIG.rootOrientation,i={};return this.stackParentId&&(t=="NORTH"||t=="SOUTH"?t="WEST":(t=="EAST"||t=="WEST")&&(t="NORTH")),t=="NORTH"?(i.x=this.pseudo?this.X-this.Tree().CONFIG.subTeeSeparation/2:this.X+this.width/2,i.y=n?this.Y+this.height:this.Y):t=="SOUTH"?(i.x=this.pseudo?this.X-this.Tree().CONFIG.subTeeSeparation/2:this.X+this.width/2,i.y=n?this.Y:this.Y+this.height):t=="EAST"?(i.x=n?this.X:this.X+this.width,i.y=this.pseudo?this.Y-this.Tree().CONFIG.subTeeSeparation/2:this.Y+this.height/2):t=="WEST"&&(i.x=n?this.X+this.width:this.X,i.y=this.pseudo?this.Y-this.Tree().CONFIG.subTeeSeparation/2:this.Y+this.height/2),i},pathStringThrough:function(){var n=this.connectorPoint(!0),t=this.connectorPoint(!1);return["M",n.x+","+n.y,"L",t.x+","+t.y].join(" ")},drawLineThroughMe:function(t){var r=t?this.Tree().getPointPathString(t):this.pathStringThrough(),i;this.lineThroughMe=this.lineThroughMe||this.Tree()._R.path(r);i=n.cloneObj(this.connStyle.style);delete i["arrow-start"];delete i["arrow-end"];this.lineThroughMe.attr(i);t&&(this.lineThroughMe.hide(),this.lineThroughMe.hidden=!0)},addSwitchEvent:function(t){var i=this;n.addEvent(t,"click",function(n){n.preventDefault();i.toggleCollapse()})},toggleCollapse:function(){var n=this.Tree();n.inAnimation||(n.inAnimation=!0,this.collapsed=!this.collapsed,this.collapsed?$(this.nodeDOM).addClass("collapsed"):$(this.nodeDOM).removeClass("collapsed"),n.positionTree(),setTimeout(function(){n.inAnimation=!1},n.CONFIG.animation.nodeSpeed>n.CONFIG.animation.connectorsSpeed?n.CONFIG.animation.nodeSpeed:n.CONFIG.animation.connectorsSpeed))},hide:function(n){var f;this.nodeDOM.style.overflow="hidden";var t=$(this.nodeDOM),i=this.Tree(),u=i.CONFIG,r={left:n.x,top:n.y};this.hidden||(r.width=r.height=0);this.startW&&this.startH||(this.startW=t.outerWidth(),this.startH=t.outerHeight());!this.positioned||this.hidden?(this.nodeDOM.style.visibility="hidden",t.css(r),this.positioned=!0):t.animate(r,u.animation.nodeSpeed,u.animation.nodeAnimation,function(){this.style.visibility="hidden"});this.lineThroughMe&&(f=i.getPointPathString(n),this.hidden?this.lineThroughMe.attr({path:f}):i.animatePath(this.lineThroughMe,i.getPointPathString(n)));this.hidden=!0},show:function(){this.nodeDOM.style.visibility="visible";var n={left:this.X,top:this.Y},t=this.Tree(),i=t.CONFIG;this.hidden&&(n.width=this.startW,n.height=this.startH);$(this.nodeDOM).animate(n,i.animation.nodeSpeed,i.animation.nodeAnimation,function(){this.style.overflow=""});this.lineThroughMe&&t.animatePath(this.lineThroughMe,this.pathStringThrough());this.hidden=!1}};t.prototype.createGeometry=function(n){var s,e,i,r,u,o,f;if(this.id===0&&n.CONFIG.hideRootNode){this.width=0;this.height=0;return}if(s=n.drawArea,i=this.link.href?document.createElement("a"):document.createElement("div"),i.className=this.pseudo?"pseudo":t.CONFIG.nodeHTMLclass,this.nodeHTMLclass&&!this.pseudo&&(i.className+=" "+this.nodeHTMLclass),this.nodeHTMLid&&(i.id=this.nodeHTMLid),this.link.href&&(i.href=this.link.href,i.target=this.link.target),!this.pseudo){if(this.nodeInnerHTML)this.nodeInnerHTML.charAt(0)==="#"?(o=document.getElementById(this.nodeInnerHTML.substring(1)),o?(i=o.cloneNode(!0),i.id+="-clone",i.className+=" node"):i.innerHTML="<b> Wrong ID selector <\/b>"):i.innerHTML=this.nodeInnerHTML;else if(this.image&&(e=document.createElement("img"),e.src=this.image,i.appendChild(e)),this.text)for(r in this.text)t.CONFIG.textClass[r]&&(u=document.createElement(this.text[r].href?"a":"p"),this.text[r].href&&(u.href=this.text[r].href,this.text[r].target&&(u.target=this.text[r].target)),u.className=t.CONFIG.textClass[r],u.appendChild(document.createTextNode(this.text[r].val?this.text[r].val:this.text[r]instanceof Object?"'val' param missing!":this.text[r])),i.appendChild(u));(this.collapsed||this.collapsable&&this.childrenCount()&&!this.stackParentId)&&(f=document.createElement("a"),f.className="collapse-switch",i.appendChild(f),this.addSwitchEvent(f),this.collapsed&&(i.className+=" collapsed"))}s.appendChild(i);this.width=i.offsetWidth;this.height=i.offsetHeight;this.nodeDOM=i;n.imageLoader.processNode(this)};i.CONFIG={maxDepth:100,rootOrientation:"NORTH",nodeAlign:"CENTER",levelSeparation:30,siblingSeparation:30,subTeeSeparation:30,hideRootNode:!1,animateOnInit:!1,animateOnInitDelay:500,padding:15,scrollbar:"native",connectors:{type:"curve",style:{stroke:"black"},stackIndent:15},node:{link:{target:"_self"}},animation:{nodeSpeed:450,nodeAnimation:"linear",connectorsSpeed:450,connectorsAnimation:"linear"}};t.CONFIG={nodeHTMLclass:"node",textClass:{name:"node-name",title:"node-title",desc:"node-desc",contact:"node-contact"}};o={make:function(n){var i=n.length,t;for(this.jsonStructure={chart:null,nodeStructure:null};i--;){if(t=n[i],t.hasOwnProperty("container")){this.jsonStructure.chart=t;continue}t.hasOwnProperty("parent")||t.hasOwnProperty("container")||(this.jsonStructure.nodeStructure=t,t.myID=this.getID())}return this.findChildren(n),this.jsonStructure},findChildren:function(n){for(var i=[0],t;i.length;){for(var f=i.pop(),e=this.findNode(this.jsonStructure.nodeStructure,f),r=0,o=n.length,u=[];r<o;r++)t=n[r],t.parent&&t.parent.myID==f&&(t.myID=this.getID(),delete t.parent,u.push(t),i.push(t.myID));u.length&&(e.children=u)}},findNode:function(n,t){var i,r;if(n.myID===t)return n;if(n.children)for(i=n.children.length;i--;)if(r=this.findNode(n.children[i],t),r)return r},getID:function(){var n=0;return function(){return n++}}()};f=function(n,t){n instanceof Array&&(n=o.make(n));var i=r.createTree(n);i.positionTree(t);this.tree_id=i.id};f.prototype.destroy=function(){r.destroy(this.tree_id)};window.Treant=f})()
